<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PagerDuty Incident Generator</title>
    <style>
        label { margin-right: 10px; }
        .row { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Notification Tool Jr V1</h1>

    <div class="row">
        <label for="ticket_number">Pager Duty Number:</label>
        <input type="number" id="ticket_number" name="ticket_number">
        <button onclick="submitTicket()">Submit</button>
    </div>

    <div class="row">
        <label>Title Prefixes:</label>
        <input type="checkbox" id="retrospective" name="prefix" value="Retrospective"> Retrospective
        <input type="checkbox" id="resolved" name="prefix" value="Resolved" onchange="prefillNotes()"> Resolved
        <input type="checkbox" id="downgraded" name="prefix" value="Downgraded"> Downgraded
    </div>

    <div class="row">
        <label for="update">Update:</label>
        <select id="update" onchange="prefillNotes()">
            <!-- Options 1 to 99 -->
            <script>
                for (let i = 1; i <= 99; i++) {
                    document.write(`<option value="${i}">${i}</option>`);
                }
            </script>
        </select>

        <label>Time Zone:</label>
        <input type="radio" id="eastern" name="timezone" value="Eastern" checked onchange="prefillNotes()"> Eastern
        <input type="radio" id="utc" name="timezone" value="UTC" onchange="prefillNotes()"> UTC
    </div>

    <div class="row">
        <label for="notes">NOTES:</label><br>
        <textarea id="notes" rows="10" cols="80" spellcheck="true"></textarea>
    </div>

    <div class="row">
        <button onclick="generateOutput()">Generate</button>
        <button onclick="copyOutput()">Copy</button>
    </div>

    <script>
        let title = "";

        function submitTicket() {
            const ticketNumber = document.getElementById("ticket_number").value;
            fetch('/fetch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'ticket_number=' + encodeURIComponent(ticketNumber)
            })
            .then(response => response.json())
            .then(data => {
                title = data.title;
                alert("Ticket fetched successfully!");
            })
            .catch(error => {
                console.error("Error fetching ticket:", error);
                alert("Failed to fetch ticket.");
            });
        }

        function prefillNotes() {
            const update = document.getElementById("update").value;
            const resolvedChecked = document.getElementById("resolved").checked;
            let notes = "";

            if (update === "1" && !resolvedChecked) {
                notes = "- SRO US was alerted via :\n- SRO US is investigating the issue, with the support teams\n- More updates to follow Status Dashboard\n\nhttps://discoveryinc.pagerduty.com/status-dashboard";
            } else if (update === "1" && resolvedChecked) {
                notes = "- SRO US was alerted via :\n- SRO US is investigating the issue, with the support teams\n- This incident is resolved, no further communications will be sent out.\n\nhttps://discoveryinc.pagerduty.com/status-dashboard";
            } else if (update !== "1" && !resolvedChecked) {
                notes = "- \n- More updates to follow Status Dashboard\n\nhttps://discoveryinc.pagerduty.com/status-dashboard";
            } else if (update !== "1" && resolvedChecked) {
                notes = "- \n- This incident is resolved, no further communications will be sent out.\n\nhttps://discoveryinc.pagerduty.com/status-dashboard";
            }

            document.getElementById("notes").value = notes;
        }

        function generateOutput() {
            const update = document.getElementById("update").value;
            const timezone = document.querySelector('input[name="timezone"]:checked').value;
            const prefixes = [];
            if (document.getElementById("retrospective").checked) prefixes.push("Retrospective");
            if (document.getElementById("resolved").checked) prefixes.push("Resolved");
            if (document.getElementById("downgraded").checked) prefixes.push("Downgraded");

            const now = new Date();
            const options = { timeZone: timezone === "Eastern" ? "America/New_York" : "UTC", hour12: false };
            const formatter = new Intl.DateTimeFormat('en-GB', {
                ...options,
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
            const formattedDate = formatter.format(now).replace(",", "");
            const outDate = formattedDate + " (" + timezone + ")";

            const notes = document.getElementById("notes").value;
            const output = `${title}\n\n${prefixes.join(" ")} Update ${update} | ${outDate}\n\n${notes}`;
            document.getElementById("notes").value = output;
            navigator.clipboard.writeText(output).then(() => {
                alert("Copy successful!");
            });
        }

        function copyOutput() {
            const output = document.getElementById("notes").value;
            navigator.clipboard.writeText(output).then(() => {
                alert("Copy successful!");
            });
        }
    </script>
</body>
</html>
