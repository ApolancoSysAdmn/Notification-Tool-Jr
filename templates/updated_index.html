<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Notification Tool Jr. V1</title>
    <style>
        label { margin-right: 10px; }
        .row { margin-bottom: 10px; }
        textarea { width: 100%; }
    </style>
</head>
<body>
    <h1>Notification Tool Jr. V1</h1>

    <div class="row">
        <label for="ticket_number">Pager Duty Number:</label>
        <input type="text" id="ticket_number" name="ticket_number">
        <button onclick="submitTicket()">Submit</button>
    </div>

    <div class="row">
        <div id="titleDisplay" style="font-weight: bold;"></div>
    </div>

    <div class="row">
        <label>Title Prefixes:</label>
        <input type="checkbox" id="retrospective" name="prefix" value="Retrospective"> Retrospective
        <input type="checkbox" id="resolved" name="prefix" value="Resolved"> Resolved
        <input type="checkbox" id="downgraded" name="prefix" value="Downgraded"> Downgraded
    </div>

    <div class="row">
        <label for="update">Update:</label>
        <select id="update">
            <script>
                for (let i = 1; i <= 99; i++) {
                    document.write(`<option value="${i}">${i}</option>`);
                }
            </script>
        </select>

        <label>Time Zone:</label>
        <input type="radio" id="EST" name="timezone" value="EST" checked> Eastern
        <input type="radio" id="UTC" name="timezone" value="UTC"> UTC
    </div>

    <div class="row">
        <button id="prefillBtn" onclick="prefillNotes()">Submit</button>
        <button onclick="clearNotes()">Clear Notes</button>
    </div>

    <div class="row">
        <label for="notes">NOTES:</label><br>
        <textarea id="notes" rows="10" spellcheck="true" readonly></textarea>
    </div>

    <div class="row">
        <button onclick="generateOutput()">Generate Output</button>
        <button onclick="copyOutput()">Copy</button>
        <button onclick="sendUpdate()">Send to PagerDuty</button>
    </div>

    <div class="row">
        <label for="output">Generated Output:</label><br>
        <textarea id="output" rows="10"></textarea>
    </div>

    <script>
        let title = "";

        function submitTicket() {
            const ticketNumber = document.getElementById("ticket_number").value;
            fetch('/fetch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'ticket_number=' + encodeURIComponent(ticketNumber)
            })
            .then(response => response.json())
            .then(data => {
                title = data.title;
                document.getElementById("titleDisplay").innerText = title;
            })
            .catch(error => {
                console.error("Error fetching ticket:", error);
                document.getElementById("titleDisplay").innerText = "Failed to fetch ticket.";
            });
        }

        function prefillNotes() {
            const update = document.getElementById("update").value;
            const resolvedChecked = document.getElementById("resolved").checked;
            let notes = "";

            if (update === "1" && !resolvedChecked) {
                notes = "- SRO US was alerted via :\n- SRO US is investigating the issue, with the support teams\n- This is the initial notification. More updates will be sent when new information becomes available.\n\nStatus Dashboard - \nhttps://discoveryinc.pagerduty.com/status-dashboard";
            } else if (update === "1" && resolvedChecked) {
                notes = "- SRO US was alerted via :\n- SRO US is investigating the issue, with the support teams\n- This incident is resolved, no further communications will be sent out.\n\nStatus Dashboard - \nhttps://discoveryinc.pagerduty.com/status-dashboard";
            } else if (update !== "1" && !resolvedChecked) {
                notes = "- \n- More updates to follow\n\nStatus Dashboard - \nhttps://discoveryinc.pagerduty.com/status-dashboard";
            } else if (update !== "1" && resolvedChecked) {
                notes = "- \n- This incident is resolved, no further communications will be sent out.\n\nStatus Dashboard - \nhttps://discoveryinc.pagerduty.com/status-dashboard";
            }

            const notesBox = document.getElementById("notes");
            notesBox.value = notes;
            notesBox.readOnly = false;
            document.getElementById("prefillBtn").disabled = true;
        }

        function clearNotes() {
            const notesBox = document.getElementById("notes");
            notesBox.value = "";
            notesBox.readOnly = true;
            document.getElementById("output").value = "";
            document.getElementById("prefillBtn").disabled = false;
        }

        function generateOutput() {
            const update = document.getElementById("update").value;
            const timezone = document.querySelector('input[name="timezone"]:checked').value;
            const prefixes = [];
            if (document.getElementById("retrospective").checked) prefixes.push("Retrospective");
            if (document.getElementById("resolved").checked) prefixes.push("Resolved");
            if (document.getElementById("downgraded").checked) prefixes.push("Downgraded");

            const now = new Date();
            const timeZoneOption = timezone === "EST" ? "America/New_York" : "UTC";
            const formatter = new Intl.DateTimeFormat('en-GB', {
                timeZone: timeZoneOption,
                year: 'numeric', month: 'long', day: '2-digit',
                hour: '2-digit', minute: '2-digit',
                hour12: false
            });

            const parts = formatter.formatToParts(now);
            const dateParts = {};
            parts.forEach(p => { dateParts[p.type] = p.value; });
            const outDate = `${dateParts.day}-${dateParts.month}-${dateParts.year} | ${dateParts.hour}:${dateParts.minute} (${timezone})`;

            const notes = document.getElementById("notes").value;
            const output = `${title}\n\n${prefixes.join(" ")} Update ${update} | ${outDate}\n\n${notes}`;
            const outputBox = document.getElementById("output");
            outputBox.value = output;

            navigator.clipboard.writeText(output).then(() => {
                alert("Output copied to clipboard!");
            });
        }

        function copyOutput() {
            const output = document.getElementById("output").value;
            navigator.clipboard.writeText(output).then(() => {
                alert("Copy successful!");
            });
        }

        function sendUpdate() {
            const ticketNumber = document.getElementById("ticket_number").value;
            const updateText = document.getElementById("output").value;

            fetch('/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'ticket_number=' + encodeURIComponent(ticketNumber) + '&update_text=' + encodeURIComponent(updateText)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.status);
            })
            .catch(error => {
                console.error("Error sending update:", error);
                alert("Failed to send update.");
            });
        }
    </script>
</body>
</html>
